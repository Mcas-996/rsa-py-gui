# GitLab CI/CD configuration for RSA GUI (Rust version)
# Supports multi-platform compilation: Linux, macOS, Windows

stages:
  - build
  - test
  - package
  - deploy

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTFLAGS: "-C embed-bitcode=no"

# Cache configuration
cache:
  key: ${CI_JOB_NAME}
  paths:
    - .cargo/
    - target/

# Build matrix for three platforms
.build_template: &build_template
  stage: build
  before_script:
    - rustc --version
    - cargo --version
  script:
    - cargo build --release --target ${TARGET}
  artifacts:
    paths:
      - target/${TARGET}/release/rsa-gui*
    expire_in: 1 week

# Linux build
build:linux:
  <<: *build_template
  image: rust:1.75
  variables:
    TARGET: x86_64-unknown-linux-gnu
  allow_failure: false

# macOS build
build:macos:
  <<: *build_template
  tags:
    - macos
  variables:
    TARGET: x86_64-apple-darwin
  allow_failure: false

# Windows build
build:windows:
  <<: *build_template
  tags:
    - windows
  variables:
    TARGET: x86_64-pc-windows-msvc
  allow_failure: false

# Unit tests
test:linux:
  stage: test
  image: rust:1.75
  variables:
    TARGET: x86_64-unknown-linux-gnu
  script:
    - cargo test --target ${TARGET}
  allow_failure: false

test:macos:
  stage: test
  tags:
    - macos
  variables:
    TARGET: x86_64-apple-darwin
  script:
    - cargo test --target ${TARGET}
  allow_failure: false

test:windows:
  stage: test
  tags:
    - windows
  variables:
    TARGET: x86_64-pc-windows-msvc
  script:
    - cargo test --target ${TARGET}
  allow_failure: false

# Code formatting check
lint:check:
  stage: test
  image: rust:1.75
  script:
    - rustup component add rustfmt
    - cargo fmt --check
  allow_failure: false

# Clippy linting
lint:clippy:
  stage: test
  image: rust:1.75
  variables:
    TARGET: x86_64-unknown-linux-gnu
  script:
    - rustup component add clippy
    - cargo clippy --target ${TARGET} --all-features -- -D warnings
  allow_failure: false

# Security audit
audit:security:
  stage: test
  image: rust:1.75
  script:
    - cargo install cargo-audit || true
    - cargo audit
  allow_failure: true

# Create release packages
package:linux:
  stage: package
  image: rust:1.75
  variables:
    TARGET: x86_64-unknown-linux-gnu
  dependencies:
    - build:linux
  script:
    - mkdir -p release/${TARGET}
    - cp target/${TARGET}/release/rsa-gui release/${TARGET}/
    - cd release && tar -czf rsa-gui-linux-x86_64.tar.gz ${TARGET}
    - mv release/rsa-gui-linux-x86_64.tar.gz .
  artifacts:
    paths:
      - rsa-gui-linux-x86_64.tar.gz
    expire_in: 1 month
  allow_failure: false

package:macos:
  stage: package
  tags:
    - macos
  variables:
    TARGET: x86_64-apple-darwin
  dependencies:
    - build:macos
  script:
    - mkdir -p release/${TARGET}
    - cp target/${TARGET}/release/rsa-gui release/${TARGET}/
    - cd release && tar -czf rsa-gui-macos-x86_64.tar.gz ${TARGET}
    - mv release/rsa-gui-macos-x86_64.tar.gz .
  artifacts:
    paths:
      - rsa-gui-macos-x86_64.tar.gz
    expire_in: 1 month
  allow_failure: false

package:windows:
  stage: package
  tags:
    - windows
  variables:
    TARGET: x86_64-pc-windows-msvc
  dependencies:
    - build:windows
  script:
    - mkdir -p release/${TARGET}
    - cp target/${TARGET}/release/rsa-gui.exe release/${TARGET}/
    - cd release && tar -czf rsa-gui-windows-x86_64.tar.gz ${TARGET}
    - mv release/rsa-gui-windows-x86_64.tar.gz .
  artifacts:
    paths:
      - rsa-gui-windows-x86_64.tar.gz
    expire_in: 1 month
  allow_failure: false

# Deploy to GitLab releases (optional)
deploy:release:
  stage: deploy
  dependencies:
    - package:linux
    - package:macos
    - package:windows
  script:
    - echo "Deploying to GitLab releases..."
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  allow_failure: true