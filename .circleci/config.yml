version: 2.1

executors:
  rust-linux:
    docker:
      - image: cimg/rust:1.75
    working_directory: ~/repo

  rust-macos-arm:
    macos:
      xcode: "15.0.0"
    resource_class: macos.m1.pro.large
    environment:
      - RUSTUP_HOME: /Users/distiller/.rustup
      - CARGO_HOME: /Users/distiller/.cargo
    working_directory: ~/repo

  rust-windows:
    machine:
      image: windows-server-2019-vs2019:current
    resource_class: large
    working_directory: C:/project

jobs:
  build-linux-arm:
    executor: rust-linux
    steps:
      - checkout
      - run:
          name: Install ARM cross-compilation tools
          command: |
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            sudo apt-get install -y libssl-dev:arm64 pkg-config-aarch64-linux-gnu
            rustup target add aarch64-unknown-linux-gnu
      - run:
          name: Build for Linux ARM64
          command: |
            cd rust
            cargo build --release --target aarch64-unknown-linux-gnu
      - persist_to_workspace:
          root: rust/target
          paths:
            - aarch64-unknown-linux-gnu/release/rsa-gui

  build-macos-arm:
    executor: rust-macos-arm
    steps:
      - checkout
      - run:
          name: Install Rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bash_profile
      - run:
          name: Build for macOS ARM64
          command: |
            source ~/.cargo/env
            cd rust
            cargo build --release --target aarch64-apple-darwin
      - persist_to_workspace:
          root: rust/target
          paths:
            - aarch64-apple-darwin/release/rsa-gui

  build-windows:
    executor: rust-windows
    steps:
      - checkout
      - run:
          name: Install Rust
          command: |
            rustup default stable
            rustup target add x86_64-pc-windows-gnu
      - run:
          name: Build for Windows x86_64
          command: |
            cd rust
            cargo build --release --target x86_64-pc-windows-gnu
      - persist_to_workspace:
          root: rust/target
          paths:
            - x86_64-pc-windows-gnu/release/rsa-gui.exe

workflows:
  build-all-platforms:
    jobs:
      - build-linux-arm
      - build-macos-arm
      - build-windows